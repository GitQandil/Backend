# =======================================================================
#  Elastic Beanstalk â€“ Environment Configuration
# =======================================================================

option_settings:
  aws:elasticbeanstalk:application:environment:
    SPRING_PROFILES_ACTIVE : prod
    JAVA_HOME              : /usr/lib/jvm/java-17-amazon-corretto
    MAIL_USERNAME          : ${MAIL_USERNAME}
    MAIL_PASSWORD          : ${MAIL_PASSWORD}
    OPENAI_API_KEY         : ${OPENAI_API_KEY}
    OPENAI_ASSISTANT_ID    : ${OPENAI_ASSISTANT_ID}

# -----------------------------------------------------------------------
#  Apache HTTPD tuning (proxy + CORS)
# -----------------------------------------------------------------------
files:
  "/etc/httpd/conf.d/20-cors.conf":
    owner : root
    group : root
    mode  : "000644"
    content: |
      <IfModule mod_headers.c>
          Header always set Access-Control-Allow-Origin  "${ALLOWED_ORIGINS}"
          Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
          Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
          Header always set Access-Control-Allow-Credentials "true"
      </IfModule>

      # Respond immediately to CORS preflight
      <IfModule mod_rewrite.c>
          RewriteEngine On
          RewriteCond %{REQUEST_METHOD} =OPTIONS
          RewriteRule ^(.*)$ $1 [R=204,L]
      </IfModule>

container_commands:
  01_reload_httpd:
    command    : "service httpd reload"
    leader_only: true
